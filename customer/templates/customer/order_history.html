{% extends "customer/base.html" %}
{% block content %}

<div class="container py-5">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <h2 class="mb-1"><i class="bi bi-list-check me-2"></i>Order History</h2>
            <p class="text-muted mb-0">You have {{ orders_count }} order{{ orders_count|pluralize }}</p>
        </div>
        <a href="{% url 'customer_home' %}" class="btn btn-outline-primary">
            <i class="bi bi-arrow-left me-1"></i> Continue Shopping
        </a>
    </div>

    {% if page_obj %}
    <div class="accordion" id="ordersAccordion">
        {% for order in page_obj %}
        <div class="accordion-item mb-3 shadow-sm">
            <h2 class="accordion-header" id="heading{{ forloop.counter }}">
                <button class="accordion-button {% if not forloop.first %}collapsed{% endif %}" 
                        type="button" data-bs-toggle="collapse" 
                        data-bs-target="#collapse{{ forloop.counter }}" 
                        aria-expanded="{% if forloop.first %}true{% else %}false{% endif %}" 
                        aria-controls="collapse{{ forloop.counter }}">
                    <div class="d-flex justify-content-between align-items-center w-100 me-3">
                        <div>
                            <span class="fw-bold me-2">Order #{{ order.order_id|slice:":12" }}...</span>
                            <span class="badge bg-{% if order.payment_status == 'Completed' %}success{% else %}warning{% endif %}">
                                {{ order.payment_status }}
                            </span>
                        </div>
                        <div class="text-end">
                            <div class="text-muted small">{{ order.order_date|date:"M d, Y" }}</div>
                            <div class="fw-bold">₹{{ order.grand_total }}</div>
                        </div>
                    </div>
                </button>
            </h2>
            <div id="collapse{{ forloop.counter }}" 
                 class="accordion-collapse collapse {% if forloop.first %}show{% endif %}" 
                 aria-labelledby="heading{{ forloop.counter }}" 
                 data-bs-parent="#ordersAccordion">
                <div class="accordion-body">
                    <!-- Order Items -->
                    <div class="row mb-4">
                        <div class="col-12">
                            <h6 class="border-bottom pb-2 mb-3">Order Items</h6>
                            {% for product in order.products %}
                            <div class="d-flex align-items-center mb-3 p-2 border-bottom">
                                <img src="{{ product.image_path }}" 
                                     alt="{{ product.name }}" 
                                     class="img-fluid rounded me-3" 
                                     style="width: 60px; height: 60px; object-fit: cover;">
                                <div class="flex-grow-1">
                                    <h6 class="mb-1">{{ product.name }}</h6>
                                    <div class="d-flex justify-content-between">
                                        <small class="text-muted">Quantity: {{ product.quantity }}</small>
                                        <div>
                                            <span class="text-muted me-2">₹{{ product.price }} each</span>
                                            <span class="fw-semibold">₹{{ product.total }}</span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            {% endfor %}
                        </div>
                    </div>
                    
                    <!-- Order Summary -->
                    <div class="row">
                        <div class="col-md-6">
                            <h6 class="border-bottom pb-2 mb-3">Order Summary</h6>
                            <div class="d-flex justify-content-between mb-1">
                                <span>Subtotal:</span>
                                <span>₹{{ order.total_amount }}</span>
                            </div>
                            {% if order.discount_amount > 0 %}
                            <div class="d-flex justify-content-between mb-1 text-success">
                                <span>Discount:</span>
                                <span>-₹{{ order.discount_amount }}</span>
                            </div>
                            {% endif %}
                            <div class="d-flex justify-content-between mb-1">
                                <span>Shipping:</span>
                                <span>FREE</span>
                            </div>
                            <div class="d-flex justify-content-between mb-3 pt-2 border-top fw-bold">
                                <span>Total:</span>
                                <span class="text-success">₹{{ order.grand_total }}</span>
                            </div>
                        </div>
                        
                        <div class="col-md-6">
                            <h6 class="border-bottom pb-2 mb-3">Shipping Details</h6>
                            <address>
                                <strong>{{ order.shipping_address.full_name }}</strong><br>
                                {{ order.shipping_address.address }}<br>
                                {{ order.shipping_address.city }}, {{ order.shipping_address.pincode }}<br>
                                <i class="bi bi-telephone"></i> {{ order.shipping_address.phone }}
                            </address>
                        </div>
                    </div>
                    
                    <!-- Action Buttons -->
                    <div class="d-flex justify-content-end gap-2 mt-4">
                        <a href="{% url 'track_order' order_id=order.order_id %}" class="btn btn-outline-primary btn-sm">
                            <i class="bi bi-truck me-1"></i> Track Order
                        </a>
                        <button class="btn btn-outline-secondary btn-sm" onclick="printOrder('{{ order.order_id }}')">
                            <i class="bi bi-printer me-1"></i> Print
                        </button>
                    </div>
                </div>
            </div>
        </div>
        {% endfor %}
    </div>
    
    <!-- Pagination -->
    {% if page_obj.has_other_pages %}
    <nav aria-label="Order history pagination" class="mt-4">
        <ul class="pagination justify-content-center">
            {% if page_obj.has_previous %}
            <li class="page-item">
                <a class="page-link" href="?page=1">&laquo; First</a>
            </li>
            <li class="page-item">
                <a class="page-link" href="?page={{ page_obj.previous_page_number }}">Previous</a>
            </li>
            {% endif %}
            
            {% for num in page_obj.paginator.page_range %}
                {% if page_obj.number == num %}
                <li class="page-item active">
                    <span class="page-link">{{ num }}</span>
                </li>
                {% elif num > page_obj.number|add:'-3' and num < page_obj.number|add:'3' %}
                <li class="page-item">
                    <a class="page-link" href="?page={{ num }}">{{ num }}</a>
                </li>
                {% endif %}
            {% endfor %}
            
            {% if page_obj.has_next %}
            <li class="page-item">
                <a class="page-link" href="?page={{ page_obj.next_page_number }}">Next</a>
            </li>
            <li class="page-item">
                <a class="page-link" href="?page={{ page_obj.paginator.num_pages }}">Last &raquo;</a>
            </li>
            {% endif %}
        </ul>
    </nav>
    {% endif %}
    
    {% else %}
    <div class="text-center py-5">
        <i class="bi bi-cart-x display-1 text-muted"></i>
        <h3 class="mt-3">No orders yet</h3>
        <p class="text-muted">You haven't placed any orders yet.</p>
        <a href="{% url 'customer_home' %}" class="btn btn-primary mt-2">
            <i class="bi bi-cart me-1"></i> Start Shopping
        </a>
    </div>
    {% endif %}
</div>

<style>
.accordion-button:not(.collapsed) {
    background-color: #f8f9fa;
    box-shadow: inset 0 -1px 0 rgba(0,0,0,.125);
}

.accordion-button:focus {
    box-shadow: none;
    border-color: rgba(0,0,0,.125);
}

.order-item-img {
    width: 60px;
    height: 60px;
    object-fit: cover;
}

.page-link {
    color: #0d6efd;
}

.page-item.active .page-link {
    background-color: #0d6efd;
    border-color: #0d6efd;
}
</style>

<script>
function printOrder(orderId) {
    // You can implement a print functionality for individual orders
    window.print();
}
</script>

{% endblock %}