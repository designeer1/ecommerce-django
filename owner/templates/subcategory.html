{% extends 'base.html' %}
{% load static %}
{% block content %}
<div class="container py-5">
  <h2 class="mb-4 text-center">Manage Subcategories</h2>
  <!-- Top Row: Add button + Search + Count -->
  <div class="d-flex justify-content-between align-items-center mb-3">
    <button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#addProductModal">
      + Add Subcategory/Product
    </button>
    <div class="w-50 position-relative">
      <input type="text" id="searchSubcatInput" class="form-control" placeholder="Search subcategories...">
      <ul id="searchDropdown" class="list-group position-absolute w-100 shadow-sm" 
          style="z-index:1050; display:none; max-height:280px; overflow-y:auto; border-radius:8px; padding:0.5rem; background:#fff; box-shadow: 0 4px 8px rgba(0,0,0,0.1);"></ul>
    </div>
    <span class="badge bg-dark p-2">Total: <span id="subcategoryCount">0</span></span>
  </div>
  <!-- Filter & Sort Controls -->
  <div class="d-flex justify-content-between align-items-center mb-3">
    <!-- Filter by Category -->
    <div class="d-flex align-items-center">
      <label for="filterCategory" class="me-2 fw-bold">Filter:</label>
      <select id="filterCategory" class="form-select" style="width:200px;">
        <option value="">All Categories</option>
        {% for cat in categories %}
          <option value="{{ cat }}">{{ cat }}</option>
        {% endfor %}
      </select>
    </div>
    <!-- Sort Dropdown -->
    <div class="d-flex align-items-center">
      <label for="sortSelect" class="me-2 fw-bold">Sort:</label>
      <select id="sortSelect" class="form-select" style="width:200px;">
        <option value="">Default</option>
        <option value="name_asc">Name ↑</option>
        <option value="name_desc">Name ↓</option>
        <option value="price_asc">Price ↑</option>
        <option value="price_desc">Price ↓</option>
      </select>
    </div>
    <!-- Apply Button -->
    <button id="applyFilterSort" class="btn btn-outline-primary ms-2">Apply</button>
  </div>
  <!-- Subcategories Table -->
  <div id="subcategoryTable" class="table-responsive">
    <table class="table table-bordered align-middle text-center shadow-sm">
      <thead class="table-dark">
        <tr>
          <th>ID</th>
          <th>Image</th>
          <th>Category</th>
          <th>Subcategory</th>
          <th>Product Name</th>
          <th>Price</th>
          <th>Description</th>
          <th>Actions</th>
        </tr>
      </thead>
      <tbody>
        {% for subcat in page_obj %}
          <tr 
            data-category="{{ subcat.category }}" 
            data-subcategory="{{ subcat.subcategory }}" 
            data-name="{{ subcat.name }}" 
            data-price="{{ subcat.price }}" 
            data-description="{{ subcat.description|default:'' }}" 
            data-image="{{ subcat.image|default:'/media/products/default.png' }}">
            <td>{{ forloop.counter0|add:page_obj.start_index }}</td>
            <td>
              <img src="{{ subcat.image|default:'/media/products/default.png' }}" alt="{{ subcat.name }}"
                   style="width:50px;height:50px;object-fit:cover;border-radius:4px;">
            </td>
            <td>{{ subcat.category }}</td>
            <td>{{ subcat.subcategory }}</td>
            <td>{{ subcat.name }}</td>
            <td>₹ {{ subcat.price }}</td>
            <td>
              <span class="description-text" title="{{ subcat.description|default:'No description' }}">
                {{ subcat.description|default:'No description'|truncatechars:30 }}
              </span>
            </td>
            <td>
              <button class="btn btn-warning btn-sm me-1 edit-btn">Edit</button>
              <a href="{% url 'delete_subcategory' subcat.category subcat.name %}" 
                 class="btn btn-danger btn-sm"
                 onclick="return confirm('Delete {{ subcat.name }}?');">Delete</a>
            </td>
          </tr>
        {% empty %}
          <tr>
            <td colspan="8" class="text-center text-muted">No subcategories yet.</td>
          </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
  <!-- Pagination -->
  {% if page_obj.has_other_pages %}
    <nav aria-label="Page navigation">
      <ul class="pagination justify-content-center">
        {% if page_obj.has_previous %}
          <li class="page-item"><a class="page-link" href="?page={{ page_obj.previous_page_number }}">Previous</a></li>
        {% else %}
          <li class="page-item disabled"><span class="page-link">Previous</span></li>
        {% endif %}
        {% for num in page_obj.paginator.page_range %}
          {% if page_obj.number == num %}
            <li class="page-item active"><span class="page-link">{{ num }}</span></li>
          {% else %}
            <li class="page-item"><a class="page-link" href="?page={{ num }}">{{ num }}</a></li>
          {% endif %}
        {% endfor %}
        {% if page_obj.has_next %}
          <li class="page-item"><a class="page-link" href="?page={{ page_obj.next_page_number }}">Next</a></li>
        {% else %}
          <li class="page-item disabled"><span class="page-link">Next</span></li>
        {% endif %}
      </ul>
    </nav>
  {% endif %}
  <!-- Add Subcategory/Product Modal -->
  <div class="modal fade" id="addProductModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content">
        <form method="post" enctype="multipart/form-data" action="{% url 'add_subcategory' %}">
          {% csrf_token %}
          <div class="modal-header">
            <h5 class="modal-title">Add Subcategory/Product</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
          </div>
          <div class="modal-body">
            <div class="mb-3">
              <label for="addCategory" class="form-label">Category</label>
              <select name="category" id="addCategory" class="form-select" required>
                {% for cat in categories %}
                  <option value="{{ cat }}">{{ cat }}</option>
                {% endfor %}
              </select>
            </div>
            <div class="mb-3">
              <label for="addSubcategory" class="form-label">Subcategory Name</label>
              <input type="text" name="subcategory" id="addSubcategory" class="form-control" required>
            </div>
            <div class="mb-3">
              <label for="addName" class="form-label">Product Name</label>
              <input type="text" name="name" id="addName" class="form-control" required>
            </div>
            <div class="mb-3">
              <label for="addPrice" class="form-label">Price</label>
              <input type="number" step="0.01" name="price" id="addPrice" class="form-control" required>
            </div>
            <div class="mb-3">
              <label for="addDescription" class="form-label">Description</label>
              <textarea name="description" id="addDescription" class="form-control" rows="3"></textarea>
            </div>
            <div class="mb-3">
              <label for="addImage" class="form-label">Image</label>
              <input type="file" name="image" id="addImage" class="form-control" accept="image/*">
            </div>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            <button type="submit" class="btn btn-primary">Add</button>
          </div>
        </form>
      </div>
    </div>
  </div>
  <!-- Edit Subcategory/Product Modal -->
  <div class="modal fade" id="editSubcatModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content">
        <form id="editSubcatForm" method="post" enctype="multipart/form-data">
          {% csrf_token %}
          <div class="modal-header">
            <h5 class="modal-title">Edit Subcategory/Product</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
          </div>
          <div class="modal-body">
            <input type="hidden" name="old_category" id="editOldCategory">
            <input type="hidden" name="old_name" id="editOldName">
            <div class="mb-3">
              <label for="editCategory" class="form-label">Category</label>
              <select name="category" id="editCategory" class="form-select" required>
                {% for cat in categories %}
                  <option value="{{ cat }}">{{ cat }}</option>
                {% endfor %}
              </select>
            </div>
            <div class="mb-3">
              <label for="editSubcategory" class="form-label">Subcategory Name</label>
              <input type="text" name="subcategory" id="editSubcategory" class="form-control" required>
            </div>
            <div class="mb-3">
              <label for="editName" class="form-label">Product Name</label>
              <input type="text" name="name" id="editName" class="form-control" required>
            </div>
            <div class="mb-3">
              <label for="editPrice" class="form-label">Price</label>
              <input type="number" step="0.01" name="price" id="editPrice" class="form-control" required>
            </div>
            <div class="mb-3">
              <label for="editDescription" class="form-label">Description</label>
              <textarea name="description" id="editDescription" class="form-control" rows="3"></textarea>
            </div>
            <div class="mb-3">
              <label for="editImage" class="form-label">Image</label>
              <input type="file" name="image" id="editImage" class="form-control" accept="image/*">
              <img id="currentImage" src="" style="width:80px;height:80px;object-fit:cover;margin-top:10px;">
            </div>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            <button type="submit" class="btn btn-primary">Update</button>
          </div>
        </form>
      </div>
    </div>
  </div>
</div>
<style>
.description-text { 
  display:inline-block; max-width:200px; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;
  color:#0d6efd; font-style:italic; 
}
.description-text:hover { color:#005cbf; cursor:pointer; }
#searchDropdown li {
  cursor: default;
  background: #fff;
  margin-bottom: 8px;
  border: 1px solid #ddd;
  border-radius: 8px;
  padding: 12px;
}
#searchDropdown li:hover { background:#f0f8ff; }
#searchDropdown p.text-truncate {
  color:#0d6efd; 
  font-style:italic; 
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
}
#searchDropdown {
  max-height: 280px;
  overflow-y: auto;
  box-shadow: 0 4px 8px rgba(0,0,0,0.1);
  padding: 0.5rem;
  z-index: 1050;
}
.dropdown-link { color:#0d6efd; font-weight:bold; text-decoration:none; }
.dropdown-link:hover { color:#0056b3; text-decoration:underline; }
</style>
<script>
document.addEventListener("DOMContentLoaded", function() {
  const searchInput = document.getElementById("searchSubcatInput");
  const resultsList = document.getElementById("searchDropdown");
  const totalCount = document.getElementById("subcategoryCount");
  const form = document.getElementById("editSubcatForm");

  // Load total count
  fetch("{% url 'get_subcategory_count' %}")
    .then(res => res.json())
    .then(data => totalCount.innerText = data.count);

  // Live search
  searchInput.addEventListener("keyup", function() {
    const query = this.value.trim();
    if(query.length < 2) { 
      resultsList.style.display = "none"; 
      return; 
    }
    fetch("{% url 'search_subcategories' %}?q=" + encodeURIComponent(query))
      .then(res => res.json())
      .then(data => {
        resultsList.innerHTML = "";
        if(data.results.length === 0) {
          const li = document.createElement("li");
          li.className = "list-group-item text-center text-muted";
          li.innerText = "No results found";
          resultsList.appendChild(li);
          resultsList.style.display = "block";
          return;
        }
        data.results.forEach(sc => {
          const li = document.createElement("li");
          li.className = "list-group-item p-3 shadow-sm my-2";
          li.style.borderRadius = "8px";
          li.innerHTML = `
            <div class="d-flex align-items-center">
              <img src="${sc.image || '/media/products/default.png'}" alt="${sc.name}"
                style="width:60px; height:60px; object-fit:cover; border-radius:6px; margin-right:12px;">
              <div class="flex-grow-1">
                <h6 class="mb-1">${sc.category} → ${sc.subcategory}</h6>
                <p class="mb-1 fw-bold">${sc.name} - ₹${parseFloat(sc.price).toFixed(2)}</p>
                <p class="mb-2 text-truncate" style="max-width:300px;" title="${sc.description || 'No description'}">
                  ${sc.description ? sc.description.substring(0, 100) : 'No description'}
                </p>
                <div>
                  <button class="btn btn-warning btn-sm me-1 edit-dropdown-btn"
                    data-category="${sc.category}" data-name="${sc.name}"
                    data-subcategory="${sc.subcategory}"
                    data-price="${sc.price}"
                    data-description="${sc.description || ''}"
                    data-image="${sc.image || '/media/products/default.png'}"
                    >
                    Edit
                  </button>
                  <a href="/owner/subcategories/delete/${encodeURIComponent(sc.category)}/${encodeURIComponent(sc.name)}"
                    class="btn btn-danger btn-sm"
                    onclick="return confirm('Delete ${sc.name}?');">
                    Delete
                  </a>
                </div>
              </div>
            </div>
          `;

          // Edit button event to fill modal and show
          li.querySelector(".edit-dropdown-btn").addEventListener("click", function() {
            const btn = this;
            document.getElementById("editOldCategory").value = btn.dataset.category;
            document.getElementById("editOldName").value = btn.dataset.name;
            document.getElementById("editCategory").value = btn.dataset.category;
            document.getElementById("editSubcategory").value = btn.dataset.subcategory || '';
            document.getElementById("editName").value = btn.dataset.name;
            document.getElementById("editPrice").value = btn.dataset.price;
            document.getElementById("editDescription").value = btn.dataset.description || '';
            document.getElementById("currentImage").src = btn.dataset.image || '/media/products/default.png';

            form.action = `/owner/subcategories/edit/${encodeURIComponent(btn.dataset.category)}/${encodeURIComponent(btn.dataset.name)}/`;

            const modal = new bootstrap.Modal(document.getElementById("editSubcatModal"));
            modal.show();

            resultsList.style.display = "none";
          });

          resultsList.appendChild(li);
        });
        resultsList.style.display = "block";
      });
  });

  // Table Edit Button → Prefill Modal
  document.querySelectorAll(".edit-btn").forEach(btn => {
    btn.addEventListener("click", function() {
      const tr = btn.closest("tr");
      document.getElementById("editOldCategory").value = tr.dataset.category;
      document.getElementById("editOldName").value = tr.dataset.name;
      document.getElementById("editCategory").value = tr.dataset.category;
      document.getElementById("editSubcategory").value = tr.dataset.subcategory;
      document.getElementById("editName").value = tr.dataset.name;
      document.getElementById("editPrice").value = tr.dataset.price;
      document.getElementById("editDescription").value = tr.dataset.description;
      document.getElementById("currentImage").src = tr.dataset.image;
      form.action = `/owner/subcategories/edit/${encodeURIComponent(tr.dataset.category)}/${encodeURIComponent(tr.dataset.name)}/`;
      const modal = new bootstrap.Modal(document.getElementById("editSubcatModal"));
      modal.show();
    });
  });

  // Filter + Sort
  const filterCategory = document.getElementById("filterCategory");
  const sortSelect = document.getElementById("sortSelect");
  const applyBtn = document.getElementById("applyFilterSort");
  applyBtn.addEventListener("click", function() {
    const rows = document.querySelectorAll("#subcategoryTable tbody tr");
    const filterValue = filterCategory.value.toLowerCase();
    const sortValue = sortSelect.value;

    let rowArray = Array.from(rows);
    rowArray.forEach(row => {
      const category = row.dataset.category.trim().toLowerCase();
      if (!filterValue || category === filterValue.trim()) {
        row.style.display = "";
      } else {
        row.style.display = "none";
      }
    });

    let visibleRows = rowArray.filter(r => r.style.display !== "none");
    if (sortValue === "name_asc" || sortValue === "name_desc") {
      visibleRows.sort((a, b) => {
        let nameA = a.dataset.name.toLowerCase();
        let nameB = b.dataset.name.toLowerCase();
        return sortValue === "name_asc" ? nameA.localeCompare(nameB) : nameB.localeCompare(nameA);
      });
    } else if (sortValue === "price_asc" || sortValue === "price_desc") {
      visibleRows.sort((a, b) => {
        let priceA = parseFloat(a.dataset.price);
        let priceB = parseFloat(b.dataset.price);
        return sortValue === "price_asc" ? priceA - priceB : priceB - priceA;
      });
    }

    const tbody = document.querySelector("#subcategoryTable tbody");
    visibleRows.forEach(row => tbody.appendChild(row));
  });
});
</script>
{% endblock %}
