{% extends 'base.html' %}
{% block content %}

<div class="container py-4">

  <!-- Header Section -->
  <div class="d-flex justify-content-between align-items-center mb-4 p-4 bg-gradient-primary rounded-4 shadow-sm">
    <div>
      <h2 class="fw-bold text-white mb-1"><i class="bi bi-tags me-2"></i>Category Manager</h2>
      <p class="text-white-50 mb-0">Organize and manage your product categories</p>
    </div>
    
    <!-- Total Count Badge -->
    <div class="d-flex align-items-center">
      <span id="category-count" class="badge bg-white text-primary fs-6 shadow-sm me-3 px-3 py-2">
        <i class="bi bi-grid-3x3 me-1"></i> {{ count }} Categories
      </span>

      <div class="btn-group">
        <button class="btn btn-light shadow-sm rounded-3 fw-semibold" data-bs-toggle="modal" data-bs-target="#addCategoryModal">
          <i class="bi bi-plus-circle me-2"></i> Add New
        </button>
        <button type="button" class="btn btn-light dropdown-toggle dropdown-toggle-split" data-bs-toggle="dropdown" aria-expanded="false">
          <span class="visually-hidden">Toggle Dropdown</span>
        </button>
        <ul class="dropdown-menu">
          <li><a class="dropdown-item" href="#" data-bs-toggle="modal" data-bs-target="#importModal">
            <i class="bi bi-upload me-2"></i> Import CSV
          </a></li>
          <li><a class="dropdown-item" href="{% url 'export_categories' %}">
            <i class="bi bi-download me-2"></i> Export CSV
          </a></li>
        </ul>
      </div>
    </div>
  </div>

  <!-- Search + Filter Card -->
  <div class="card border-0 shadow-sm mb-4">
    <div class="card-body p-4">
      <form method="GET" class="row g-3 align-items-end">
        <div class="col-md-5 position-relative">
          <label class="form-label fw-semibold text-muted small mb-1">Search Categories</label>
          <div class="input-group">
            <span class="input-group-text bg-transparent border-end-0"><i class="bi bi-search text-muted"></i></span>
            <input type="text" id="liveSearch" 
                   class="form-control border-start-0 ps-0" 
                   placeholder="Type at least 2 letters...">
          </div>
          
          <!-- live results container -->
          <div id="searchResults" 
               class="list-group position-absolute w-100 mt-1 shadow" 
               style="max-height:250px; overflow-y:auto; z-index:1000; display:none;">
          </div>
        </div>
        
        <div class="col-md-4">
          <label class="form-label fw-semibold text-muted small mb-1">Sort Options</label>
          <select name="sort" class="form-select">
            <option value="">Default Sorting</option>
            <option value="name" {% if request.GET.sort == 'name' %}selected{% endif %}>Name (A-Z)</option>
            <option value="-name" {% if request.GET.sort == '-name' %}selected{% endif %}>Name (Z-A)</option>
            <option value="created_at" {% if request.GET.sort == 'created_at' %}selected{% endif %}>Newest First</option>
            <option value="-created_at" {% if request.GET.sort == '-created_at' %}selected{% endif %}>Oldest First</option>
          </select>
        </div>
        
        <div class="col-md-3 d-flex gap-2">
          <button type="submit" class="btn btn-primary flex-fill"><i class="bi bi-funnel me-1"></i> Apply Filters</button>
          <a href="{% url 'manage_category' %}" class="btn btn-outline-secondary"><i class="bi bi-arrow-repeat"></i></a>
        </div>
      </form>
    </div>
  </div>

  <!-- Import Status Alert -->
  {% if import_status %}
  <div class="alert alert-{{ import_status.type }} alert-dismissible fade show" role="alert">
    <i class="bi bi-{{ import_status.icon }} me-2"></i>
    {{ import_status.message }}
    {% if import_status.errors %}
    <ul class="mb-0 mt-2">
      {% for error in import_status.errors %}
      <li>{{ error }}</li>
      {% endfor %}
    </ul>
    {% endif %}
    <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
  </div>
  {% endif %}

  <!-- Category Table Card -->
  <div class="card border-0 shadow-sm">
    <div class="card-body p-0">
      <div class="table-responsive">
        <table class="table table-hover align-middle mb-0">
          <thead class="table-light">
            <tr>
              <th class="ps-4">#</th>
              <th>Image</th>
              <th>Name</th>
              <th>Description</th>
              <th class="text-center pe-4">Actions</th>
            </tr>
          </thead>
          <tbody>
            {% for cat in page_obj %}
            <tr class="border-bottom">
              <td class="ps-4 text-muted">{{ forloop.counter }}</td>
              <td>
                <div class="category-img-container">
                  {% if cat.image %}
                    <img src="{{ cat.image.url }}" class="rounded-3 shadow-sm" style="width:60px; height:60px; object-fit:cover;">
                  {% else %}
                    <div class="d-flex align-items-center justify-content-center rounded-3 bg-light text-muted" style="width:60px; height:60px;">
                      <i class="bi bi-image" style="font-size: 1.5rem;"></i>
                    </div>
                  {% endif %}
                </div>
              </td>
              <td class="fw-semibold">{{ cat.name }}</td>
              <td class="text-muted">{{ cat.description|default:"—" }}</td>
              <td class="text-center pe-4">
                <div class="btn-group btn-group-sm" role="group">
                  <a href="{% url 'edit_category' cat.name %}" class="btn btn-outline-primary">
                    <i class="bi bi-pencil-square me-1"></i> Edit
                  </a>
                  <a href="{% url 'delete_category' cat.name %}" class="btn btn-outline-danger"
                     onclick="return confirm('Are you sure you want to delete {{ cat.name }}?');">
                    <i class="bi bi-trash me-1"></i> Delete
                  </a>
                </div>
              </td>
            </tr>
            {% empty %}
            <tr>
              <td colspan="5" class="text-center text-muted py-5">
                <i class="bi bi-inbox display-6 d-block mb-2"></i>
                <h5 class="fw-semibold">No categories found</h5>
                <p class="text-muted">Get started by adding your first category</p>
                <button class="btn btn-primary mt-2" data-bs-toggle="modal" data-bs-target="#addCategoryModal">
                  <i class="bi bi-plus-circle me-1"></i> Add Category
                </button>
              </td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    </div>
  </div>

  <!-- Pagination -->
  {% if page_obj.has_other_pages %}
    <nav aria-label="Page navigation" class="mt-4">
      <ul class="pagination justify-content-center">
        {% if page_obj.has_previous %}
          <li class="page-item">
            <a class="page-link" href="?page={{ page_obj.previous_page_number }}">
              <i class="bi bi-chevron-left"></i>
            </a>
          </li>
        {% endif %}
        
        {% for num in page_obj.paginator.page_range %}
          {% if page_obj.number == num %}
            <li class="page-item active"><a class="page-link" href="#">{{ num }}</a></li>
          {% elif num > page_obj.number|add:'-3' and num < page_obj.number|add:'3' %}
            <li class="page-item"><a class="page-link" href="?page={{ num }}">{{ num }}</a></li>
          {% endif %}
        {% endfor %}
        
        {% if page_obj.has_next %}
          <li class="page-item">
            <a class="page-link" href="?page={{ page_obj.next_page_number }}">
              <i class="bi bi-chevron-right"></i>
            </a>
          </li>
        {% endif %}
      </ul>
    </nav>
  {% endif %}

</div>

<!-- Add Category Modal -->
<div class="modal fade" id="addCategoryModal" tabindex="-1" aria-labelledby="addCategoryModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content shadow-lg border-0 rounded-4">
      <div class="modal-header bg-primary text-white rounded-top-4 py-3">
        <h5 class="modal-title"><i class="bi bi-plus-circle me-2"></i> Add New Category</h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <form method="POST" enctype="multipart/form-data">
        {% csrf_token %}
        <div class="modal-body py-4">
          <div class="mb-3">
            <label class="form-label fw-semibold">Category Name</label>
            {{ form.name }}
          </div>
          <div class="mb-3">
            <label class="form-label fw-semibold">Description</label>
            {{ form.description }}
          </div>
          <div class="mb-4">
            <label class="form-label fw-semibold">Category Image</label>
            {{ form.image }}
            <div class="form-text">Recommended size: 300×300 pixels</div>
          </div>
        </div>
        <div class="modal-footer border-0">
          <button type="button" class="btn btn-outline-secondary rounded-3" data-bs-dismiss="modal">Cancel</button>
          <button type="submit" class="btn btn-primary rounded-3 px-4"><i class="bi bi-save me-1"></i> Save Category</button>
        </div>
      </form>
    </div>
  </div>
</div>

<!-- Import Categories Modal -->
<div class="modal fade" id="importModal" tabindex="-1" aria-labelledby="importModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content shadow-lg border-0 rounded-4">
      <div class="modal-header bg-info text-white rounded-top-4 py-3">
        <h5 class="modal-title"><i class="bi bi-upload me-2"></i> Import Categories from CSV</h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <form method="POST" action="{% url 'import_categories' %}" enctype="multipart/form-data" id="importForm">
        {% csrf_token %}
        <div class="modal-body py-4">
          <div class="mb-4">
            <label class="form-label fw-semibold">CSV File</label>
            <input type="file" name="csv_file" class="form-control" accept=".csv" required>
            <div class="form-text">
              CSV format: name,description (optional). 
              <a href="{% url 'export_categories' %}" class="text-decoration-none">Download template</a>
            </div>
          </div>
          
          <div class="form-check mb-3">
            <input class="form-check-input" type="checkbox" name="has_headers" id="hasHeaders" checked>
            <label class="form-check-label" for="hasHeaders">
              First row contains headers
            </label>
          </div>
          
          <div class="alert alert-warning">
            <i class="bi bi-exclamation-triangle me-2"></i>
            Existing categories with the same name will be updated.
          </div>
        </div>
        <div class="modal-footer border-0">
          <button type="button" class="btn btn-outline-secondary rounded-3" data-bs-dismiss="modal">Cancel</button>
          <button type="submit" class="btn btn-info text-white rounded-3 px-4">
            <i class="bi bi-upload me-1"></i> Import Categories
          </button>
        </div>
      </form>
    </div>
  </div>
</div>

<style>
  .bg-gradient-primary {
    background: linear-gradient(135deg, #4e73df 0%, #224abe 100%);
  }
  
  .category-img-container {
    transition: transform 0.2s;
  }
  
  .category-img-container:hover {
    transform: scale(1.05);
  }
  
  .table th {
    border-top: none;
    font-weight: 600;
    text-transform: uppercase;
    font-size: 0.85rem;
    letter-spacing: 0.5px;
    color: #6c757d;
  }
  
  .table-hover tbody tr:hover {
    background-color: rgba(78, 115, 223, 0.05);
  }
  
  #searchResults {
    border-radius: 0.5rem;
  }
  
  #searchResults a {
    border: none;
    border-bottom: 1px solid #f0f0f0;
    padding: 0.75rem 1rem;
  }
  
  #searchResults a:last-child {
    border-bottom: none;
  }
  
  #searchResults a:hover {
    background-color: #f8f9fa;
  }
  
  .page-item.active .page-link {
    background-color: #4e73df;
    border-color: #4e73df;
  }
  
  .page-link {
    color: #4e73df;
  }
</style>

<script>
/* 🔍 Live Search */
document.getElementById("liveSearch").addEventListener("keyup", function() {
    let query = this.value;
    let resultsBox = document.getElementById("searchResults");

    if (query.length < 2) {
        resultsBox.style.display = "none";
        return;
    }

    fetch(`/owner/search-categories/?q=${query}`)
        .then(response => response.json())
        .then(data => {
            resultsBox.innerHTML = "";
            resultsBox.style.display = "block";

            if (data.results.length === 0) {
                resultsBox.innerHTML = `<div class="list-group-item text-muted">No matching categories found</div>`;
            } else {
                data.results.forEach(cat => {
                    resultsBox.innerHTML += `
                        <a href="{% url 'edit_category' 'PLACEHOLDER' %}".replace('PLACEHOLDER', cat.name) 
                           class="list-group-item list-group-item-action d-flex align-items-center">
                          <img src="${cat.image}" width="40" height="40" class="rounded me-3" style="object-fit:cover;">
                          <div>
                            <div class="fw-semibold">${cat.name}</div>
                            <small class="text-muted">${cat.description || 'No description'}</small>
                          </div>
                        </a>`;
                });
            }
        });
});

// Hide search results when clicking elsewhere
document.addEventListener('click', function(e) {
  if (!document.getElementById('liveSearch').contains(e.target) && 
      !document.getElementById('searchResults').contains(e.target)) {
    document.getElementById('searchResults').style.display = 'none';
  }
});

/* 🔄 Auto Update Total Count */
function updateCategoryCount() {
  fetch("{% url 'category_count' %}")
    .then(response => response.json())
    .then(data => {
      document.getElementById("category-count").innerHTML = 
        `<i class="bi bi-grid-3x3 me-1"></i> ${data.count} Categories`;
    });
}

// Update count every 5 seconds
setInterval(updateCategoryCount, 5000);
updateCategoryCount();

// Handle import form submission
document.getElementById('importForm').addEventListener('submit', function(e) {
  // Show loading state
  const submitBtn = this.querySelector('button[type="submit"]');
  submitBtn.innerHTML = '<span class="spinner-border spinner-border-sm me-1" role="status" aria-hidden="true"></span> Importing...';
  submitBtn.disabled = true;
});
</script>

{% endblock %}